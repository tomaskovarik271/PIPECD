# Testing Plan: Teams, Reassignment & Followers Functionality

## 1. Introduction

This document outlines the test plan for the "Teams," "Deal Reassignment," and "Deal Followers" features. The goal is to ensure all aspects of this new functionality are working as expected, are secure, and integrate correctly with the existing CRM system.

## 2. Prerequisites & Setup

### 2.1. User Roles & Accounts for Testing
At least three types of user accounts should be prepared with varying permission sets:
*   **Admin User:** Has all permissions, including `manage_any` for `team` and `team_membership`, `deal:reassign`, `deal_follower:manage_any`.
*   **Team Lead User (User A):** A regular user who will be designated as a team lead for one or more teams. Should have `team_membership:manage_own` and potentially other relevant permissions for their role (e.g., basic deal/contact creation).
*   **Regular User (User B):** A standard user with basic CRM access (e.g., create/read own deals/contacts). Will be a member of a team.
*   **Regular User (User C):** Another standard user, potentially not part of any team initially, or part of a different team.

### 2.2. Required Permissions
Ensure the following permissions are defined in `public.permissions` and assigned to appropriate roles (especially the 'admin' role and a potential 'team_lead' role or directly to users):
*   `('team', 'create')`
*   `('team', 'read_any')`
*   `('team', 'update_any')`
*   `('team', 'delete_any')`
*   `('team', 'manage_any')`
*   `('team_membership', 'manage_any')`
*   `('team_membership', 'manage_own')`
*   `('deal', 'reassign')`
*   `('deal_follower', 'manage_any')`
*   Standard CRUD permissions for deals, people, organizations, activities (`read_own`, `create`, `update_own`, `delete_own`, `read_any`, `update_any`, `delete_any`).

### 2.3. Test Data
*   Multiple user profiles.
*   Existing deals, people, organizations, and activities owned by different users.
*   Pipelines and Stages.

## 3. Test Case Template

Each test case should follow this format:

| Field             | Description                                                                 |
|-------------------|-----------------------------------------------------------------------------|
| **Test Case ID**  | Unique identifier (e.g., TF_CORE_001)                                       |
| **Feature Area**  | e.g., Core Teams, Team Lead Visibility, Deal Reassignment, Deal Followers |
| **Description**   | Brief description of the test objective.                                    |
| **Actor(s)**      | User role(s) performing the test (Admin, Team Lead, Regular User).          |
| **Preconditions** | Any setup required before executing the test.                               |
| **Test Steps**    | Numbered steps to execute the test.                                         |
| **Expected Result**| What the outcome should be.                                                 |
| **Actual Result** | (To be filled during testing)                                               |
| **Status**        | (Pass/Fail - To be filled during testing)                                   |
| **Notes**         | Any additional comments or observations.                                    |

---

## 4. Core Teams Functionality Test Cases

### 4.1. Team CRUD Operations

| Test Case ID  | Feature Area | Description                                                                  | Actor(s)    | Preconditions                                                                   | Test Steps                                                                                                                                                                                                                                                                                                                                                       | Expected Result                                                                                                                                                                                                                                                                                                                                                            |
|---------------|--------------|------------------------------------------------------------------------------|-------------|---------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TF_CORE_001   | Core Teams   | Admin creates a new team successfully (with team lead).                      | Admin       | Admin user logged in. User A exists.                                            | 1. Navigate to Team Management UI. <br> 2. Initiate "Create Team". <br> 3. Input Team Name (e.g., "Sales Alpha"), Description. <br> 4. Select User A as Team Lead. <br> 5. Save.                                                                                                                                                                           | Team "Sales Alpha" is created. <br> User A is set as team_lead_user_id. <br> `created_at`, `updated_at`, `created_by_user_id` (Admin's ID) are set. <br> Team appears in team list. <br> GraphQL `createTeam` mutation returns the new team.                                                                                                                          |
| TF_CORE_002   | Core Teams   | Admin creates a new team successfully (without team lead).                   | Admin       | Admin user logged in.                                                           | 1. Initiate "Create Team". <br> 2. Input Team Name (e.g., "Support Crew"), Description. <br> 3. Do not select a Team Lead. <br> 4. Save.                                                                                                                                                                                                                          | Team "Support Crew" is created. <br> `team_lead_user_id` is null. <br> Team appears in team list.                                                                                                                                                                                                                                                                           |
| TF_CORE_003   | Core Teams   | Admin attempts to create a team with a duplicate name.                       | Admin       | Admin logged in. Team "Sales Alpha" exists.                                     | 1. Initiate "Create Team". <br> 2. Input Team Name "Sales Alpha". <br> 3. Save.                                                                                                                                                                                                                                                                              | Error message indicating duplicate team name. Team is not created. <br> GraphQL mutation returns an appropriate error.                                                                                                                                                                                                                                                  |
| TF_CORE_004   | Core Teams   | Admin views team details.                                                    | Admin       | Admin logged in. Team "Sales Alpha" exists with User A as lead.                 | 1. Navigate to team list. <br> 2. Select "Sales Alpha".                                                                                                                                                                                                                                                                                                    | Admin can see all details of "Sales Alpha" (name, description, lead, members (if any), audit fields). <br> GraphQL `team(id:)` query returns full team details.                                                                                                                                                                                                               |
| TF_CORE_005   | Core Teams   | Admin updates an existing team's name, description, and team lead.         | Admin       | Admin logged in. Team "Sales Alpha" (lead User A) exists. User B exists.        | 1. Select "Sales Alpha" for editing. <br> 2. Change Name to "Sales Champions". <br> 3. Update Description. <br> 4. Change Team Lead from User A to User B. <br> 5. Save.                                                                                                                                                                                    | Team details are updated. <br> Name is "Sales Champions". <br> Description is updated. <br> Team Lead is User B. <br> `updated_at` field is updated. <br> GraphQL `updateTeam` mutation returns updated team.                                                                                                                                                                  |
| TF_CORE_006   | Core Teams   | Admin updates a team to have no team lead.                                   | Admin       | Admin logged in. Team "Sales Champions" (lead User B) exists.                   | 1. Select "Sales Champions" for editing. <br> 2. Set Team Lead to null/none. <br> 5. Save.                                                                                                                                                                                                                                                                      | Team Lead for "Sales Champions" is now null. <br> `updated_at` field is updated.                                                                                                                                                                                                                                                                                           |
| TF_CORE_007   | Core Teams   | Admin deletes an existing team.                                              | Admin       | Admin logged in. Team "Support Crew" exists.                                    | 1. Select "Support Crew" from list. <br> 2. Initiate "Delete Team". <br> 3. Confirm deletion.                                                                                                                                                                                                                                                                      | Team "Support Crew" is removed from the system. <br> Associated `team_members` entries are cascaded deleted. <br> GraphQL `deleteTeam` mutation returns true.                                                                                                                                                                                                              |
| TF_CORE_008   | Core Teams   | Non-Admin attempts to create/update/delete a team (via UI if possible/API).  | Regular User| Regular User B logged in.                                                       | 1. Attempt to access Team Management admin section. <br> 2. Attempt to call `createTeam`/`updateTeam`/`deleteTeam` GraphQL mutations directly with appropriate inputs.                                                                                                                                                                                                       | Access to admin section denied. <br> GraphQL mutations return "Forbidden" / permission error. No changes made to teams.                                                                                                                                                                                                                                                     |
| TF_CORE_009   | Core Teams   | Team Lead (User A) views their own team details.                             | Team Lead A | User A is lead of "Sales Champions".                                            | 1. User A logs in. <br> 2. Accesses "My Led Teams" or views "Sales Champions" details.                                                                                                                                                                                                                                                                        | User A can see details of "Sales Champions". <br> RLS on `teams` table (`auth.uid() = team_lead_user_id`) allows this.                                                                                                                                                                                                                                                        |
| TF_CORE_010   | Core Teams   | Team Lead (User A) attempts to view details of a team they do not lead.    | Team Lead A | User A is lead of "Sales Champions". Another team "Marketing Wizards" exists.   | 1. User A logs in. <br> 2. Attempts to query/view details for "Marketing Wizards" (e.g., via GraphQL `team(id:)` if ID is known).                                                                                                                                                                                                                            | User A cannot view details of "Marketing Wizards" unless they also have `team:read_any` permission. <br> GraphQL query returns null or error if ID is for a non-accessible team.                                                                                                                                                                                                   |

### 4.2. Team Membership Management

| Test Case ID  | Feature Area | Description                                                                         | Actor(s)    | Preconditions                                                                                          | Test Steps                                                                                                                                                                                                                                                                                                                                                       | Expected Result                                                                                                                                                                                                                                                                                                                                                                                                                             |
|---------------|--------------|-------------------------------------------------------------------------------------|-------------|--------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TF_MEM_001    | Core Teams   | Admin adds a single member (User B) to Team "Sales Champions".                      | Admin       | Admin logged in. Team "Sales Champions" exists. User B exists and is not yet a member.                 | 1. Select "Sales Champions". <br> 2. Go to "Manage Members". <br> 3. Add User B (optionally specify role, e.g., 'member'). <br> 4. Save.                                                                                                                                                                                                      | User B is added to "Sales Champions". <br> A new row in `team_members` table is created. <br> `joined_at` is set. `role` is 'member' (or as specified). <br> GraphQL `addTeamMembers` (used for single too) returns `TeamWithMembers` including User B.                                                                                                                                                                    |
| TF_MEM_002    | Core Teams   | Admin adds multiple members (User C, User D) to Team "Sales Champions" (bulk).        | Admin       | Admin logged in. Team "Sales Champions" exists. Users C, D exist and are not members.                  | 1. Select "Sales Champions". <br> 2. Go to "Manage Members". <br> 3. Select Users C and D for bulk add (optionally specify a common role). <br> 4. Save.                                                                                                                                                                                         | Users C and D are added. <br> New rows in `team_members`. <br> GraphQL `addTeamMembers` returns `TeamWithMembers` including new members.                                                                                                                                                                                                                                                                                                   |
| TF_MEM_003    | Core Teams   | Admin attempts to add a non-existent user to a team.                                | Admin       | Admin logged in. Team "Sales Champions" exists.                                                        | 1. Select "Sales Champions". <br> 2. Attempt to add a user by a non-existent ID/email.                                                                                                                                                                                                                                                           | Error message. User is not added. <br> GraphQL `addTeamMembers` returns an error or team unchanged if one user fails. (Verify behavior of batch operation: all fail or partial success?). Service `addTeamMembersToDb` suggests batch fails on any error.                                                                                                                                                                              |
| TF_MEM_004    | Core Teams   | Admin attempts to add an already existing member (User B) to Team "Sales Champions" with the same role. | Admin       | Admin logged in. Team "Sales Champions" exists. User B is already a 'member'.            | 1. Select "Sales Champions". <br> 2. Attempt to add User B again as 'member'.                                                                                                                                                                                                                                                                 | Error due to primary key violation (`team_id`, `user_id`, `role`). <br> User B is not added again. <br> GraphQL `addTeamMembers` returns an error.                                                                                                                                                                                                                                                                                       |
| TF_MEM_005    | Core Teams   | Admin removes a single member (User B) from Team "Sales Champions".                 | Admin       | Admin logged in. Team "Sales Champions" exists. User B is a member.                                    | 1. Select "Sales Champions". <br> 2. Go to "Manage Members". <br> 3. Remove User B. <br> 4. Save.                                                                                                                                                                                                                                                 | User B is removed from "Sales Champions". <br> `team_members` row is deleted. <br> GraphQL `removeTeamMembers` returns `TeamWithMembers` excluding User B.                                                                                                                                                                                                                                                                         |
| TF_MEM_006    | Core Teams   | Admin removes multiple members (User C, User D) from Team "Sales Champions" (bulk).   | Admin       | Admin logged in. Team "Sales Champions" exists. Users C, D are members.                                | 1. Select "Sales Champions". <br> 2. Go to "Manage Members". <br> 3. Select Users C and D for bulk removal. <br> 4. Save.                                                                                                                                                                                                                             | Users C and D are removed. <br> `team_members` rows deleted. <br> GraphQL `removeTeamMembers` returns `TeamWithMembers` excluding them.                                                                                                                                                                                                                                                                                               |
| TF_MEM_007    | Core Teams   | Team Lead (User A) adds a single member (User E) to their team "Sales Champions".   | Team Lead A | User A is lead of "Sales Champions". User E exists, not a member. User A has `team_membership:manage_own`. | 1. User A logs in. <br> 2. Manages "Sales Champions". <br> 3. Adds User E.                                                                                                                                                                                                                                                                                | User E is added. <br> `team_members` row created. <br> RLS policy for Team Leads on `team_members` allows this.                                                                                                                                                                                                                                                                                           |
| TF_MEM_008    | Core Teams   | Team Lead (User A) removes a member (User C) from their team "Sales Champions".     | Team Lead A | User A is lead of "Sales Champions". User C is a member. User A has `team_membership:manage_own`.      | 1. User A logs in. <br> 2. Manages "Sales Champions". <br> 3. Removes User C.                                                                                                                                                                                                                                                                               | User C is removed. <br> `team_members` row deleted.                                                                                                                                                                                                                                                                                                                         |
| TF_MEM_009    | Core Teams   | Team Lead (User A) attempts to add/remove member from a team they DO NOT lead.    | Team Lead A | User A is lead of "Sales Champions". Team "Marketing Wizards" exists (lead by User Z). User A has `team_membership:manage_own`. | 1. User A logs in. <br> 2. Attempts to manage members of "Marketing Wizards" (e.g. via GraphQL mutation if teamId is known).                                                                                                                                                                                                                       | Action fails. Error message "Forbidden". <br> RLS policy for Team Leads on `team_members` prevents this.                                                                                                                                                                                                                                                                               |
| TF_MEM_010    | Core Teams   | Regular User B attempts to add/remove member from any team.                       | Regular User| User B logged in.                                                                                      | 1. Attempt to access member management UI/API.                                                                                                                                                                                                                                                                                                         | Action fails. Error "Forbidden".                                                                                                                                                                                                                                                                                                                                                  |

---

## 5. Team Lead Visibility Test Cases

| Test Case ID  | Feature Area         | Description                                                                    | Actor(s)    | Preconditions                                                                                                                                                                                                                             | Test Steps                                                                                                                                                                                          | Expected Result                                                                                                                                                                                                                            |
|---------------|----------------------|--------------------------------------------------------------------------------|-------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TF_VIS_001    | Team Lead Visibility | Team Lead (User A) views Deals owned by their team member (User B).            | Team Lead A | User A leads "Sales Alpha". User B is a member of "Sales Alpha". User B owns Deal X. User A does not own Deal X and has no `deal:read_any` permission.                                                                                         | 1. User A logs in. <br> 2. Navigates to Deals list/view.                                                                                                                                            | User A can see Deal X in the list and view its details. <br> RLS policy using `is_team_lead_of_item_owner(UserA_ID, UserB_ID)` for `deals` table grants access.                                                                                |
| TF_VIS_002    | Team Lead Visibility | Team Lead (User A) does NOT see Deals owned by User C (not in their team).     | Team Lead A | User A leads "Sales Alpha". User B is in "Sales Alpha". User C is NOT in "Sales Alpha" (nor in any other team led by A). User C owns Deal Y. User A has no `deal:read_any`.                                                                 | 1. User A logs in. <br> 2. Navigates to Deals list/view.                                                                                                                                            | User A does NOT see Deal Y (unless User A is also the owner or follower of Deal Y).                                                                                                                                                        |
| TF_VIS_003    | Team Lead Visibility | Team Lead (User A) views People created/owned by their team member (User B).   | Team Lead A | User A leads "Sales Alpha". User B is a member of "Sales Alpha". User B created/owns Person P. User A does not own Person P and has no `person:read_any` permission.                                                                            | 1. User A logs in. <br> 2. Navigates to People list.                                                                                                                                                | User A can see Person P. <br> RLS policy on `people` table.                                                                                                                                                                                  |
| TF_VIS_004    | Team Lead Visibility | Team Lead (User A) views Organizations created/owned by team member (User B).  | Team Lead A | User A leads "Sales Alpha". User B is a member of "Sales Alpha". User B created/owns Organization O. User A does not own Org O and has no `organization:read_any` permission.                                                                  | 1. User A logs in. <br> 2. Navigates to Organizations list.                                                                                                                                         | User A can see Organization O. <br> RLS policy on `organizations` table.                                                                                                                                                                    |
| TF_VIS_005    | Team Lead Visibility | Team Lead (User A) views Activities associated with their team member (User B).| Team Lead A | User A leads "Sales Alpha". User B is a member of "Sales Alpha". Activity V is associated with (e.g. assigned to, created by) User B. User A has no `activity:read_any`.                                                                  | 1. User A logs in. <br> 2. Navigates to Activities list or views activities linked to items owned by User B.                                                                                       | User A can see Activity V. <br> RLS policy on `activities` table.                                                                                                                                                                             |
| TF_VIS_006    | Team Lead Visibility | User B (member, not lead) cannot see items of another team member (User D) based on team leadership. | Regular User B | User A leads "Sales Alpha". Users B and D are members of "Sales Alpha". User D owns Deal Z. User B is not owner, not admin, not follower of Deal Z. Current design does not grant intra-team visibility by default (Sec 4.4). | 1. User B logs in. <br> 2. Navigates to Deals list.                                                                                                                                                 | User B does NOT see Deal Z (unless specific intra-team visibility is later implemented and granted).                                                                                                                                           |
| TF_VIS_007    | Team Lead Visibility | Admin user with `read_any` can see all items, regardless of team structure.    | Admin       | Admin has `deal:read_any`, `person:read_any` etc. Deal X (User B), Deal Y (User C) exist.                                                                                                                                                 | 1. Admin logs in. <br> 2. Views all deals/people.                                                                                                                                                 | Admin sees Deal X, Deal Y, and all other items.                                                                                                                                                                                              |

---

## 6. Deal Reassignment Test Cases

| Test Case ID  | Feature Area     | Description                                                                                    | Actor(s)    | Preconditions                                                                                                                               | Test Steps                                                                                                                                                                                                                                                                                             | Expected Result                                                                                                                                                                                                                                                                                                                                                       |
|---------------|------------------|------------------------------------------------------------------------------------------------|-------------|---------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TF_REASSIGN_001 | Deal Reassignment| Admin reassigns Deal X from User B to User C. Previous owner (User B) added as follower (default). | Admin       | Admin logged in. Deal X owned by User B. User C exists. Admin has `deal:reassign`.                                                          | 1. Admin selects Deal X. <br> 2. Initiates "Reassign Deal". <br> 3. Selects User C as new owner. <br> 4. Ensures "Add previous owner as follower" is checked/default. <br> 5. Confirms.                                                                                                                 | Deal X `user_id` is updated to User C's ID. <br> `deal_history` logs the reassignment (old owner, new owner, acting user). <br> User B is added to `deal_followers` for Deal X. <br> GraphQL `reassignDeal` mutation succeeds, returns updated Deal. <br> User B (previous owner) can still view Deal X (as a follower). User C (new owner) can view Deal X (as owner). |
| TF_REASSIGN_002 | Deal Reassignment| Admin reassigns Deal X, previous owner NOT added as follower.                                  | Admin       | Admin logged in. Deal X owned by User B. User C exists.                                                                                     | 1. Admin selects Deal X. <br> 2. Initiates "Reassign Deal". <br> 3. Selects User C as new owner. <br> 4. Unchecks "Add previous owner as follower". <br> 5. Confirms.                                                                                                                                  | Deal X `user_id` is updated to User C. <br> User B is NOT added to `deal_followers`. <br> User B loses access to Deal X (unless other visibility rule applies).                                                                                                                                                                                                      |
| TF_REASSIGN_003 | Deal Reassignment| Team Lead A (with `deal:reassign` perm) reassigns a deal owned by their team member.             | Team Lead A | Team Lead A leads "Sales Alpha", User B is member. Deal X owned by User B. User E is another user. Team Lead A has `deal:reassign` permission. | 1. Team Lead A logs in. <br> 2. Selects Deal X. <br> 3. Reassigns to User E.                                                                                                                                                                                                                          | Reassignment successful. (Same outcomes as TF_REASSIGN_001 for owner change, history, follower).                                                                                                                                                                                                                                      |
| TF_REASSIGN_004 | Deal Reassignment| User without `deal:reassign` permission attempts to reassign a deal.                             | Regular User| User B owns Deal X. User C (no `deal:reassign` perm) logs in.                                                                               | 1. User C attempts to reassign Deal X (via UI if option visible, or API).                                                                                                                                                                                                                             | Action fails. "Forbidden" error. Deal ownership unchanged.                                                                                                                                                                                                                                                                                            |
| TF_REASSIGN_005 | Deal Reassignment| Reassigning a deal to its current owner.                                                         | Admin       | Deal X owned by User B.                                                                                                                     | 1. Admin selects Deal X. <br> 2. Attempts to reassign to User B (current owner).                                                                                                                                                                                                                         | System handles gracefully: either no change occurs and current deal data is returned, or a message indicates deal is already owned by the selected user. No error. No history entry for this no-op.                                                                                                                                                |
| TF_REASSIGN_006 | Deal Reassignment| Reassigning a non-existent deal.                                                                 | Admin       | Admin logged in.                                                                                                                            | 1. Admin attempts to call `reassignDeal` GraphQL mutation with a non-existent `dealId`.                                                                                                                                                                                                          | GraphQL mutation returns "Not Found" error or similar.                                                                                                                                                                                                                                                                                                  |
| TF_REASSIGN_007 | Deal Reassignment| Reassigning a deal to a non-existent user.                                                       | Admin       | Admin logged in. Deal X exists.                                                                                                             | 1. Admin attempts to reassign Deal X to a non-existent `newOwnerUserId`.                                                                                                                                                                                                                             | Database foreign key constraint should prevent this if `user_profiles.user_id` is checked. <br> GraphQL mutation returns an error (e.g. "User not found" or DB error).                                                                                                                                                                                     |

---

## 7. Deal Followers Test Cases

| Test Case ID | Feature Area   | Description                                                                                     | Actor(s)         | Preconditions                                                                                                                            | Test Steps                                                                                                                                                                                                                               | Expected Result                                                                                                                                                                                                                                                                                          |
|--------------|----------------|-------------------------------------------------------------------------------------------------|------------------|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TF_FOLLOW_001| Deal Followers | Admin adds User C as a follower to Deal X (owned by User B).                                    | Admin            | Admin logged in. Deal X owned by User B. User C exists, is not owner. Admin has `deal_follower:manage_any`.                               | 1. Admin selects Deal X. <br> 2. Navigates to "Manage Followers". <br> 3. Adds User C. <br> 4. Saves.                                                                                                                               | User C is added to `deal_followers` for Deal X. <br> GraphQL `addDealFollower` succeeds. <br> Deal object returned by mutation potentially shows User C in `followers` list (if field resolver for `Deal.followers` is active).                                                                         |
| TF_FOLLOW_002| Deal Followers | Deal Owner (User B) adds User C as a follower to their own Deal X.                                | Regular User B   | User B owns Deal X. User C exists. User B has implicit permission to manage followers for their own deal (or `deal:update_own`).           | 1. User B logs in. <br> 2. Selects their Deal X. <br> 3. Manages followers, adds User C.                                                                                                                                            | User C is added to `deal_followers` for Deal X.                                                                                                                                                                                                                                                        |
| TF_FOLLOW_003| Deal Followers | User C (follower) can view Deal X.                                                                | Regular User C   | User C is a follower of Deal X (owned by User B). User C is not owner, not admin, not team lead of User B.                              | 1. User C logs in. <br> 2. Navigates to Deals list or attempts to view Deal X directly.                                                                                                                                            | User C can see Deal X details. <br> RLS policy on `deals` table (SELECT) `EXISTS (SELECT 1 FROM public.deal_followers df WHERE df.deal_id = deals.id AND df.user_id = auth.uid())` grants access.                                                                                                     |
| TF_FOLLOW_004| Deal Followers | Admin removes User C as a follower from Deal X.                                                 | Admin            | User C is a follower of Deal X. Admin has `deal_follower:manage_any`.                                                                    | 1. Admin selects Deal X. <br> 2. Manages followers. <br> 3. Removes User C. <br> 4. Saves.                                                                                                                                           | User C is removed from `deal_followers` for Deal X. <br> GraphQL `removeDealFollower` succeeds. <br> User C can no longer see Deal X (unless another rule applies).                                                                                                                                    |
| TF_FOLLOW_005| Deal Followers | Deal Owner (User B) removes User C as a follower from their own Deal X.                           | Regular User B   | User B owns Deal X. User C is a follower.                                                                                                | 1. User B logs in. <br> 2. Selects Deal X. <br> 3. Manages followers, removes User C.                                                                                                                                               | User C is removed from `deal_followers`.                                                                                                                                                                                                                                                                 |
| TF_FOLLOW_006| Deal Followers | User D (not owner, not admin, not follower) cannot view Deal X.                                 | Regular User D   | Deal X owned by User B. User D has no special permissions or follower status for Deal X.                                                 | 1. User D logs in. <br> 2. Attempts to view Deal X.                                                                                                                                                                                  | User D cannot see Deal X. Access denied / Not Found.                                                                                                                                                                                                                                                       |
| TF_FOLLOW_007| Deal Followers | Attempt to add an already existing follower.                                                      | Admin            | User C is already a follower of Deal X.                                                                                                  | 1. Admin attempts to add User C again as a follower to Deal X.                                                                                                                                                                           | Operation fails gracefully or is idempotent. No duplicate entry. Primary key on `deal_followers` (`deal_id`, `user_id`) prevents duplicates. GraphQL mutation might return an error or the current state.                                                                                              |
| TF_FOLLOW_008| Deal Followers | Attempt to remove a user who is not a follower.                                                 | Admin            | User D is not a follower of Deal X.                                                                                                      | 1. Admin attempts to remove User D as a follower from Deal X.                                                                                                                                                                            | Operation completes without error (idempotent). `removeDealFollower` GraphQL mutation likely returns the Deal, unchanged regarding this non-follower. Service `removeDealFollowerFromDb` would report 0 rows affected.                                                                                      |
| TF_FOLLOW_009| Deal Followers | User E (without permissions) attempts to add/remove follower from Deal X (not their own).         | Regular User E   | Deal X owned by User B. User E has no admin/deal update permissions for Deal X.                                                          | 1. User E logs in. <br> 2. Attempts to call `addDealFollower`/`removeDealFollower` GraphQL for Deal X and another user.                                                                                                               | Action fails. "Forbidden" error. RLS on `deal_followers` based on `check_permission` for `deal:update_own`/`deal:update_any` or `deal_follower:manage_any` prevents this.                                                                                                                             |

---

## 8. GraphQL API Endpoint Test Cases

This section focuses on direct GraphQL API interaction, covering specific inputs, outputs, and error states. Many of these overlap with UI-driven tests but verify the API layer directly. Use a GraphQL client (e.g., Insomnia, Postman, Apollo Studio Explorer).

### 8.1. Team Queries

*   **`Query.team(id)`**
    *   TF_GQL_T_001: Valid ID, user has access (Admin, Team Lead of team) -> Returns `Team` object.
    *   TF_GQL_T_002: Valid ID, user no access -> Returns `null` or error consistent with RLS.
    *   TF_GQL_T_003: Invalid/non-existent ID -> Returns `null` or error.
    *   TF_GQL_T_004: Verify structure of returned `Team` (all fields present, correct types for `id`, `name`, `description`, `teamLead`, `members`, `createdAt`, `updatedAt`, `createdBy`).
*   **`Query.teams(filter, pagination)`**
    *   TF_GQL_T_005: As Admin, no filter/pagination -> Returns all teams.
    *   TF_GQL_T_006: As Admin, with pagination (limit, offset) -> Returns correct paginated subset.
    *   TF_GQL_T_007: (Future) As Admin, with filter (e.g., `nameContains` if implemented) -> Returns filtered subset.
    *   TF_GQL_T_008: As non-Admin (this query might be restricted or only return user-relevant teams via RLS, similar to `myTeams/myLedTeams` logic at service/RLS level). Expected: returns teams user can see based on RLS (teams they lead, potentially teams they are in, IF teams RLS is extended). Current `teams` resolver gets ALL teams from service, RLS on `teams` table is primary gate.
*   **`Query.myTeams`**
    *   TF_GQL_T_009: User is member of 0 teams -> Returns empty array.
    *   TF_GQL_T_010: User is member of 1 team -> Returns array with 1 team.
    *   TF_GQL_T_011: User is member of N teams -> Returns array with N teams.
*   **`Query.myLedTeams`**
    *   TF_GQL_T_012: User leads 0 teams -> Returns empty array.
    *   TF_GQL_T_013: User leads 1 team -> Returns array with 1 team.
    *   TF_GQL_T_014: User leads N teams -> Returns array with N teams.

### 8.2. Team Mutations

*   **`Mutation.createTeam(input)`**
    *   TF_GQL_TM_001: Valid input (name, desc, leadUserId) by Admin -> Returns new `Team`. `teamLead` and `createdBy` fields populated.
    *   TF_GQL_TM_002: Valid input (name only) by Admin -> Returns new `Team`. desc/leadUserId are null/default.
    *   TF_GQL_TM_003: Input with duplicate name -> Returns error.
    *   TF_GQL_TM_004: Input with non-existent `teamLeadUserId` -> Returns error (FK constraint).
    *   TF_GQL_TM_005: By non-Admin -> Returns "Forbidden" error.
*   **`Mutation.updateTeam(input)`** (Note: schema `updateTeam(input: UpdateTeamInput!)` where `UpdateTeamInput` contains `id`)
    *   TF_GQL_TM_006: Valid input (id, new name) by Admin -> Returns updated `Team`.
    *   TF_GQL_TM_007: Valid input (id, new desc, new leadUserId) by Admin -> Returns updated `Team`.
    *   TF_GQL_TM_008: Input with `id` of non-existent team -> Returns error ("Not Found" or similar).
    *   TF_GQL_TM_009: Input with `name: null` -> Returns "Bad User Input" error (name is NOT NULL).
    *   TF_GQL_TM_010: Empty update payload (only ID) -> Returns current team data, no actual DB update, or specific error if not allowed. (Resolver handles this by fetching current team).
    *   TF_GQL_TM_011: By non-Admin -> Returns "Forbidden" error.
*   **`Mutation.deleteTeam(id)`**
    *   TF_GQL_TM_012: Valid ID by Admin -> Returns `true`.
    *   TF_GQL_TM_013: Non-existent ID by Admin -> Returns error or `false` (service returns `{success: true, count:0}`). Resolver returns `true` if no error, but might throw if count is 0 based on strictness. Verify this.
    *   TF_GQL_TM_014: By non-Admin -> Returns "Forbidden" error.
*   **`Mutation.addTeamMembers(input: {teamId, memberUserIds, role?})`**
    *   TF_GQL_TM_015: Valid `teamId`, valid `memberUserIds` (array of 1), no `role` by Admin -> Returns `TeamWithMembers`. Member added with default role.
    *   TF_GQL_TM_016: Valid `teamId`, valid `memberUserIds` (array of N), with `role` by Admin -> Returns `TeamWithMembers`. Members added with specified role.
    *   TF_GQL_TM_017: Non-existent `teamId` -> Returns error.
    *   TF_GQL_TM_018: `memberUserIds` contains non-existent user ID -> Returns error (FK constraint on insert, or service handles). Batch fails.
    *   TF_GQL_TM_019: `memberUserIds` contains user already in team with that role -> Returns error (PK violation). Batch fails.
    *   TF_GQL_TM_020: Empty `memberUserIds` array -> Returns "Bad User Input" error.
    *   TF_GQL_TM_021: By Team Lead for their own team -> Returns `TeamWithMembers`.
    *   TF_GQL_TM_022: By Team Lead for another team -> Returns "Forbidden" error.
    *   TF_GQL_TM_023: Verify `TeamWithMembers` structure: `id`, `name`, `membersConnection.edges` (with `user` and `joinedAt`).
*   **`Mutation.removeTeamMembers(input: {teamId, memberUserIds})`**
    *   TF_GQL_TM_024: Valid `teamId`, valid `memberUserIds` (array of 1) by Admin -> Returns `TeamWithMembers`. Member removed.
    *   TF_GQL_TM_025: `memberUserIds` contains user not in team -> Completes successfully, non-member is ignored. Returns `TeamWithMembers`.
    *   TF_GQL_TM_026: Empty `memberUserIds` array -> Returns "Bad User Input" error.
    *   TF_GQL_TM_027: By Team Lead for their own team -> Returns `TeamWithMembers`.
    *   TF_GQL_TM_028: By Team Lead for another team -> Returns "Forbidden" error.

### 8.3. Deal Reassignment & Follower Mutations

*   **`Mutation.reassignDeal(dealId, newOwnerUserId, addPreviousOwnerAsFollower?)`**
    *   TF_GQL_DRF_001: Valid inputs by authorized user -> Returns updated `Deal`.
    *   TF_GQL_DRF_002: `addPreviousOwnerAsFollower: true` -> Previous owner becomes follower.
    *   TF_GQL_DRF_003: `addPreviousOwnerAsFollower: false` -> Previous owner does not become follower.
    *   TF_GQL_DRF_004: Non-existent `dealId` -> Error "Not Found".
    *   TF_GQL_DRF_005: Non-existent `newOwnerUserId` -> Error (FK violation or "User Not Found").
    *   TF_GQL_DRF_006: By unauthorized user -> Error "Forbidden".
*   **`Mutation.addDealFollower(dealId, userId)`**
    *   TF_GQL_DRF_007: Valid inputs by authorized user -> Returns `Deal` (potentially with updated followers list).
    *   TF_GQL_DRF_008: Non-existent `dealId` -> Error.
    *   TF_GQL_DRF_009: Non-existent `userId` (follower) -> Error (FK).
    *   TF_GQL_DRF_010: User already a follower -> Error or idempotent success.
    *   TF_GQL_DRF_011: By unauthorized user -> Error "Forbidden".
*   **`Mutation.removeDealFollower(dealId, userId)`**
    *   TF_GQL_DRF_012: Valid inputs by authorized user -> Returns `Deal`.
    *   TF_GQL_DRF_013: User is not a follower -> Idempotent success.
    *   TF_GQL_DRF_014: By unauthorized user -> Error "Forbidden".

### 8.4. Field Resolvers

*   **`Team.teamLead`**: Verify it resolves to a `User` object or `null`.
*   **`Team.members`**: Verify it resolves to `[User!]`. Test with 0, 1, N members. (Used by `GraphQLTeam`)
*   **`Team.createdBy`**: Verify it resolves to a `User` object or `null`.
*   **`TeamWithMembers.membersConnection.edges`**: Verify structure with `user` and `joinedAt`.
*   **`Deal.followers`**: Verify it resolves to `[User!]`. Test with 0, 1, N followers.

---

## 9. Error Handling & Edge Cases

| Test Case ID  | Feature Area         | Description                                                                                                 | Actor(s)    | Preconditions                                                                    | Test Steps                                                                                                                                                                                                                                                          | Expected Result                                                                                                                                                                                                                                                           |
|---------------|----------------------|-------------------------------------------------------------------------------------------------------------|-------------|----------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| TF_ERR_001    | General              | Operations with non-UUID compliant IDs (for teamId, userId etc. in GQL mutations).                          | Any         |                                                                                  | 1. Send GraphQL request with an ID like "not-a-uuid".                                                                                                                                                                                                                               | GraphQL validation error before resolver is hit, or resolver/service handles gracefully (e.g. "Invalid ID format").                                                                                                                                                 |
| TF_ERR_002    | Core Teams           | `team_members.role` default value verification.                                                             | Admin       | Admin adds member to team via `addTeamMembers` without specifying `role`.          | 1. Check `team_members` table directly or via API if role is exposed.                                                                                                                                                                                                               | Role defaults to 'member' as per DB schema.                                                                                                                                                                                                                               |
| TF_ERR_003    | General              | Impact of User Deletion on Teams (Team Lead).                                                               | Admin       | User A is lead of Team X.                                                        | 1. Admin deletes User A's profile.                                                                                                                                                                                                                                                | `teams.team_lead_user_id` for Team X becomes NULL (due to `ON DELETE SET NULL`). Team X still exists.                                                                                                                                                                    |
| TF_ERR_004    | General              | Impact of User Deletion on Teams (Team Member).                                                             | Admin       | User B is a member of Team X.                                                    | 1. Admin deletes User B's profile.                                                                                                                                                                                                                                                | Entry for User B in `team_members` table is deleted (due to `ON DELETE CASCADE`).                                                                                                                                                                                         |
| TF_ERR_005    | General              | Impact of User Deletion on Deal Followers.                                                                  | Admin       | User C is a follower of Deal Y.                                                  | 1. Admin deletes User C's profile.                                                                                                                                                                                                                                                | Entry for User C in `deal_followers` for Deal Y is deleted (due to `ON DELETE CASCADE`).                                                                                                                                                                                  |
| TF_ERR_006    | Core Teams           | Concurrency: Two admins try to update the same team simultaneously (conceptual).                            | Admin x2    | Team Z exists.                                                                   | 1. Admin 1 starts editing Team Z name. <br> 2. Admin 2 starts editing Team Z name to something else and saves. <br> 3. Admin 1 saves their change.                                                                                                                                     | Last write wins. `updated_at` reflects the latest change. No data corruption. (This tests standard DB behavior rather than specific code, but good to be aware of).                                                                                                  |
| TF_ERR_007    | Team Lead Visibility | Team member is removed from a team; team lead's visibility is revoked for that member's items.              | Team Lead A | User A leads "Sales Alpha". User B is member, owns Deal X. User A can see Deal X.  | 1. Admin removes User B from "Sales Alpha". <br> 2. User A (Team Lead) attempts to view Deal X again.                                                                                                                                                                          | User A can no longer see Deal X (unless another visibility rule applies like being a follower or admin).                                                                                                                                                                    |
| TF_ERR_008    | Team Lead Visibility | Team lead is changed for a team; old lead loses visibility, new lead gains visibility.                      | Admin       | User A leads "Sales Alpha", can see User B's (member) Deal X. User F is another user. | 1. Admin changes lead of "Sales Alpha" from User A to User F. <br> 2. User A attempts to view Deal X. <br> 3. User F (new lead) attempts to view Deal X.                                                                                                                      | User A loses visibility to Deal X (via team lead). <br> User F gains visibility to Deal X (as new team lead).                                                                                                                                                                  |
| TF_ERR_009    | RLS                  | Direct DB access attempts bypassing application logic, ensuring RLS policies hold. (Requires DB client)   | N/A (DB Test) | Users with different DB roles/permissions.                                       | 1. As a simulated regular user DB connection (not app superuser), attempt to SELECT/INSERT/UPDATE/DELETE on `teams`, `team_members`, `deals` in violation of their RLS policies (e.g. read a deal not owned, not followed, not by team member when current user is not lead). | Operations fail due to RLS policy violations.                                                                                                                                                                                                                             |

---

This testing document provides a starting point. It should be expanded with more specific edge cases and detailed API request/response checks as the testing progresses. Remember to test both "happy path" scenarios and error conditions thoroughly. 